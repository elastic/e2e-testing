---
- name: "Create AWS keypair"
  ec2_key:
    name: "e2essh-{{runId}}"
    key_material: "{{ lookup('file', sshPublicKey) }}"
    region: us-east-2
    state: present

- name: "Create elastic stack"
  ec2:
    wait: yes
    key_name: "e2essh-{{runId}}"
    region: us-east-2
    group: e2e
    image: 'ami-0629230e074c580f2'
    instance_type: c5.2xlarge
    instance_tags:
      Name: "e2e-stack-{{runId}}"
    exact_count: 1
    count_tag:
      Name: "e2e-stack-{{runId}}"
    volumes:
      - device_name: /dev/sda1
        volume_type: gp2
        volume_size: 50
        delete_on_termination: yes
  register: ec2

- name: Wait for SSH to come up
  wait_for: host={{ ec2ssh.public_ip }} port=22 delay=10 timeout=60
  loop: "{{ ec2.instances }}"
  loop_control:
    loop_var: ec2ssh

- name: Add host to groupname
  add_host: hostname={{ ec2host.public_ip }} groupname=stack_instances
  loop: "{{ ec2.instances }}"
  loop_control:
    loop_var: ec2host

- name: Create environment file
  become: no
  local_action:
    module: copy
    dest: "{{workspace}}/.env"
    content: |
      export OP_LOG_LEVEL=DEBUG
      export PROVIDER=remote
      export KIBANA_URL=http://{{ec2.instances[0].public_ip}}:5601
      export ELASTICSEARCH_URL=http://{{ec2.instances[0].public_ip}}:9200
      export FLEET_URL=http://{{ec2.instances[0].public_ip}}:8220
      export ELASTICSEARCH_PASSWORD=changeme
      export KIBANA_PASSWORD=changeme
      export SKIP_PULL=1

- name: Add stack host to address list
  become: no
  lineinfile:
    state: present
    line: "- ubuntu@{{ec2.instances[0].public_ip}}"
    insertafter: EOF
    dest: "{{workspace}}/stack-sshhosts"
    create: yes
