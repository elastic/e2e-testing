---
- name: Create test script file
  become: no
  copy:
    owner: "{{ansible_user}}"
    group: "{{ansible_user}}"
    mode: '0777'
    dest: "/home/{{ansible_user}}/e2e-testing/.ci/scripts/functional-test.sh"
    content: |
       #!/usr/bin/env bash

       ## Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
       ## or more contributor license agreements. Licensed under the Elastic License;
       ## you may not use this file except in compliance with the Elastic License.

       set -euxo pipefail
       #
       # Run the functional tests using the functional-test make goal and parse the
       # output to JUnit format.
       #
       # Parameters:
       #   - SUITE - that's the suite to be tested. Default '' which means all of them.
       #   - TAGS - that's the tags to be tested. Default '' which means all of them.
       #   - STACK_VERSION - that's the version of the stack to be tested. Default is stored in '.stack-version'.
       #   - BEAT_VERSION - that's the version of the Beat to be tested. Default is stored in '.stack-version'.
       #

       BASE_DIR="/home/${USER}/e2e-testing"
       source "${BASE_DIR}/.env"

       BASE_VERSION_PATH="${BASE_DIR}/.stack-version"
       BASE_VERSION="$(cat ${BASE_VERSION_PATH})"

       SUITE=${1:-''}
       TAGS=${2:-''}
       STACK_VERSION=${3:-"${BASE_VERSION}"}
       BEAT_VERSION=${4:-"${BASE_VERSION}"}
       GOARCH={{ lookup('env', 'GOARCH') or 'amd64' }}
       PATH=$PATH:/usr/local/go/bin

       "${BASE_DIR}/.ci/scripts/install-test-dependencies.sh" "${SUITE}"

       REPORT="${BASE_DIR}/outputs/TEST-${GOARCH}-${SUITE}"
       ELASTIC_APM_GLOBAL_LABELS="{{ lookup('env', 'ELASTIC_APM_GLOBAL_LABELS') or '' }}"
       ELASTIC_APM_SECRET_TOKEN="{{ lookup('env', 'ELASTIC_APM_SECRET_TOKEN') or '' }}"
       ELASTIC_APM_SERVER_URL="{{ lookup('env', 'ELASTIC_APM_SERVER_URL') or '' }}"
       OTEL_EXPORTER_OTLP_ENDPOINT="{{ lookup('env', 'OTEL_EXPORTER_OTLP_ENDPOINT') or '' }}"
       OTEL_EXPORTER_OTLP_HEADERS="{{ lookup('env', 'OTEL_EXPORTER_OTLP_HEADERS') or '' }}"

       TAGS="${TAGS}" FORMAT=junit:${REPORT}.xml GOARCH=${GOARCH} STACK_VERSION=${STACK_VERSION} BEAT_VERSION=${BEAT_VERSION} make --no-print-directory -C "${BASE_DIR}/e2e/_suites/${SUITE}" functional-test
